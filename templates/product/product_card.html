
{% load static %}
{% load nix %}
<div class="bg-white max-w-80 mx-auto relative group"
     x-data="{
         inWishlist: false,
         async toggleWishlist() {
             {% if user.is_authenticated %}
             try {
                 const formData = new FormData();
                 formData.append('product_id', '{{ product.id }}');
                 formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                 const response = await fetch('{% url "toggle_wishlist" %}', {
                     method: 'POST',
                     body: formData
                 });

                 const data = await response.json();
                 if (data.success) {
                     this.inWishlist = data.action === 'added';
                     // Update wishlist count in header
                     if (window.Alpine && window.Alpine.store) {
                         window.dispatchEvent(new CustomEvent('wishlist-updated'));
                     }
                 }
             } catch (error) {
                 console.error('Error toggling wishlist:', error);
             }
             {% else %}
             window.location.href = '{% url "login" %}?next={{ request.path }}';
             {% endif %}
         }
     }">
    <div class="w-full aspect-square bg-gray-100 relative overflow-hidden">
        <a href="{{ product.get_absolute_url }}" class="block w-full h-full">
            {% if product.get_primary_image_url %}
                <img src="{{ product.get_primary_image_url }}" alt="{{ product.name }}" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
            {% else %}
                <img src="https://placehold.co/150/?text=No+image?bg=ccc" alt="No image" class="w-full h-full object-cover">
            {% endif %}
        </a>

        <!-- Sale Badge -->
        {% if product.on_sale and product.discount_percentage %}
        <div class="absolute top-2 left-2 bg-red-600 text-white px-2 py-1 text-xs font-bold">
            -{{ product.discount_percentage }}%
        </div>
        {% endif %}

        <!-- New Badge -->
        {% if product.is_new_arrival %}
        <div class="absolute top-2 {% if product.on_sale %}left-16{% else %}left-2{% endif %} bg-green-600 text-white px-2 py-1 text-xs font-bold">
            NEW
        </div>
        {% endif %}

        <!-- Wishlist Button -->
        {% if user.is_authenticated %}
        <button
            @click.prevent="toggleWishlist()"
            class="absolute top-2 right-2 p-2 bg-white/90 hover:bg-white rounded-full transition-all duration-200 shadow-sm hover:shadow-md"
            :class="inWishlist ? 'opacity-100' : 'opacity-70 hover:opacity-100'"
        >
            <svg
                class="w-5 h-5 transition-colors duration-200"
                :class="inWishlist ? 'fill-red-500 stroke-red-500' : 'fill-none stroke-gray-700'"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                stroke-width="2"
            >
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
        </button>
        {% endif %}
    </div>
    <div class="p-4">
        <a href="{{ product.get_absolute_url }}" class="text-gray-800 font-semibold text-lg line-clamp-1 mb-3 hover:text-black">{{ product.name }}</a>
        <p class="text-gray-600 text-sm line-clamp-2 mb-2">{{ product.short_description }}</p>
        <div class="flex items-center gap-2 mb-2">
            {% if product.on_sale and product.get_sale_price %}
                <span class="text-red-600 font-bold text-lg">{{ product.get_sale_price|taka }}</span>
                <span class="text-gray-400 line-through text-sm">{{ product.price|taka }}</span>
            {% else %}
                <span class="text-black font-semibold text-lg">{{ product.price|taka }}</span>
            {% endif %}
        </div>
        {% stock_status product %}
    </div>
</div>